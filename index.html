<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Research Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        primaryDark: '#4B4AC9',
                        primaryLight: '#7E7DE8',
                        dark: {
                            bg: '#121212',
                            card: '#1E1E1E',
                            input: '#2D2D2D',
                            text: '#F9FAFB'
                        },
                        light: {
                            bg: '#F9FAFB',
                            card: '#FFFFFF',
                            input: '#F3F4F6',
                            text: '#1F2937'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }
                }
            }
        }
    </script>
    <style>
        /* Markdown styling */
        .markdown-content h1 { font-size: 1.8rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-content h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content h4 { font-size: 1.1rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul, .markdown-content ol { margin-left: 2rem; margin-bottom: 0.75rem; }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content pre { background-color: #f0f0f0; padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 0.75rem; overflow-x: auto; }
        .dark .markdown-content pre { background-color: #2d2d2d; }
        .markdown-content code { font-family: monospace; }
        .markdown-content blockquote { border-left: 4px solid #ddd; padding-left: 1rem; margin-left: 0; margin-bottom: 0.75rem; }
        .dark .markdown-content blockquote { border-left-color: #555; }
        .markdown-content img { max-width: 100%; height: auto; margin: 1rem 0; }
        .markdown-content table { border-collapse: collapse; margin-bottom: 0.75rem; width: 100%; }
        .markdown-content th, .markdown-content td { border: 1px solid #ddd; padding: 0.5rem; }
        .dark .markdown-content th, .dark .markdown-content td { border-color: #555; }
        
        /* Step timeline indicators */
        .timeline-container {
            position: relative;
        }
        
        .timeline-line {
            position: absolute;
            left: 15px;
            top: 24px;
            bottom: 0;
            width: 2px;
            background-color: #5D5CDE;
        }
        
        .timeline-step:last-child .timeline-line {
            display: none;
        }
        
        /* Typing animation */
        .typing-animation::after {
            content: "|";
            animation: blink 1s step-end infinite;
        }
        
        @keyframes blink {
            from, to { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* Progress bar animation */
        @keyframes progress {
            from { width: 0; }
            to { width: 100%; }
        }
        
        .animate-progress {
            animation: progress var(--duration, 5s) linear forwards;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.7);
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.5);
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(75, 85, 99, 0.7);
        }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text transition-colors duration-300">
    <div class="min-h-screen flex flex-col">
        <header class="border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-dark-card shadow-sm z-10">
            <div class="container max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19.9 13.5a9 9 0 1 1-9-9 9 9 0 0 1 9 9Z"></path>
                        <path d="M12 4.5V9"></path>
                        <path d="M9 2h6"></path>
                        <path d="M19.5 13.5 16 17"></path>
                    </svg>
                    <h1 class="text-xl md:text-2xl font-bold">Advanced Research Agent</h1>
                </div>
                <button id="themeToggle" class="flex items-center justify-center w-10 h-10 rounded-full bg-light-input dark:bg-dark-input hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">
                    <!-- Moon icon for light mode -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                    </svg>
                    <!-- Sun icon for dark mode -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="4"></circle>
                        <path d="M12 2v2"></path>
                        <path d="M12 20v2"></path>
                        <path d="m4.93 4.93 1.41 1.41"></path>
                        <path d="m17.66 17.66 1.41 1.41"></path>
                        <path d="M2 12h2"></path>
                        <path d="M20 12h2"></path>
                        <path d="m6.34 17.66-1.41 1.41"></path>
                        <path d="m19.07 4.93-1.41 1.41"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main class="flex-1 container max-w-6xl mx-auto px-4 py-8">
            <!-- Introduction Card -->
            <section id="introCard" class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <div class="flex items-center justify-center">
                    <div class="text-center">
                        <div class="flex items-center justify-center mb-4">
                            <div class="rounded-full bg-primary/10 p-3 text-primary mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19.9 13.5a9 9 0 1 1-9-9 9 9 0 0 1 9 9Z"></path>
                                    <path d="M12 4.5V9"></path>
                                    <path d="M9 2h6"></path>
                                    <path d="M19.5 13.5 16 17"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl md:text-3xl font-bold">Advanced Research Agent</h2>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">Conduct comprehensive research on any topic with an AI-powered agent that breaks down complex subjects, explores them thoroughly, and synthesizes findings into a detailed report.</p>
                    </div>
                </div>
            </section>

            <!-- Input Section -->
            <section id="inputSection" class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m12 19-2 2-2-2"></path>
                        <path d="M4 4v9a4 4 0 0 0 4 4h12"></path>
                        <path d="m8 17 4 4 4-4"></path>
                        <path d="M5 8h14"></path>
                        <path d="M5 12h4"></path>
                    </svg>
                    Research Configuration
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="researchTopic" class="block text-sm font-medium mb-2">Research Topic</label>
                        <textarea id="researchTopic" rows="4" placeholder="Enter a detailed description of what you'd like to research..." class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white"></textarea>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="researchDepth" class="block text-sm font-medium mb-2">Research Depth</label>
                            <select id="researchDepth" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                <option value="quick">Quick (5-10 min)</option>
                                <option value="standard" selected="">Standard (15-30 min)</option>
                                <option value="comprehensive">Comprehensive (30-60 min)</option>
                            </select>
                        </div>
                        <div>
                            <label for="researchStyle" class="block text-sm font-medium mb-2">Research Style</label>
                            <select id="researchStyle" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                <option value="standard" selected="">Standard</option>
                                <option value="academic">Academic</option>
                                <option value="journalistic">Journalistic</option>
                                <option value="strategic">Strategic Analysis</option>
                                <option value="technical">Technical</option>
                            </select>
                        </div>
                        <div>
                            <label for="modelSelector" class="block text-sm font-medium mb-2">AI Model</label>
                            <div class="relative">
                                <input type="text" id="modelSelector" value="DeepSeek V3" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white" readonly="">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium">Advanced Settings</label>
                        <button id="advancedSettingsToggle" class="text-sm text-primary hover:text-primaryDark transition-colors duration-200">
                            Show Advanced Settings
                        </button>
                    </div>
                    <div id="advancedSettings" class="hidden space-y-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg mt-2 bg-gray-50 dark:bg-gray-800/30">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="temperature" class="block text-sm font-medium mb-2">Temperature</label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.6" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    <span id="temperatureValue" class="text-sm min-w-12 text-center">0.6</span>
                                </div>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Lower values for more focused research, higher for more creative exploration</p>
                            </div>
                            <div>
                                <label for="maxTokens" class="block text-sm font-medium mb-2">Max Tokens</label>
                                <div class="relative">
                                    <select id="maxTokens" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                        <option value="8192">8,192 tokens</option>
                                        <option value="12288">12,288 tokens</option>
                                        <option value="16384">16,384 tokens</option>
                                        <option value="20480" selected="">20,480 tokens (Recommended)</option>
                                        <option value="24576">24,576 tokens</option>
                                        <option value="28672">28,672 tokens</option>
                                        <option value="32768">32,768 tokens (Maximum)</option>
                                    </select>
                                </div>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Maximum output length for each model call</p>
                            </div>
                        </div>
                        <div>
                            <label for="toolsToUse" class="block text-sm font-medium mb-2">Research Tools</label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="webSearch" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="webSearch" class="ml-2 text-sm">Web Search</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="dataAnalysis" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="dataAnalysis" class="ml-2 text-sm">Data Analysis</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="scholarlyArticles" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="scholarlyArticles" class="ml-2 text-sm">Scholarly Articles</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="trendAnalysis" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="trendAnalysis" class="ml-2 text-sm">Trend Analysis</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="factChecking" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="factChecking" class="ml-2 text-sm">Fact Checking</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="vizGeneration" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="vizGeneration" class="ml-2 text-sm">Visualization</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="startResearch" class="w-full mt-6 bg-primary hover:bg-primaryDark text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    Start Comprehensive Research
                </button>
            </section>

            <!-- Research Progress Section (Initially Hidden) -->
            <section id="researchProgress" class="hidden bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"></path>
                            <path d="M12 8v1"></path>
                            <path d="M12 15v1"></path>
                            <path d="M8 12H7"></path>
                            <path d="M17 12h-1"></path>
                            <circle cx="12" cy="12" r="9"></circle>
                        </svg>
                        Research in Progress
                    </h2>
                    <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 animate-pulse text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        <span id="elapsedTime">00:00</span>
                    </div>
                </div>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full bg-primary animate-pulse mr-2"></div>
                        <p class="text-sm font-medium" id="currentStepLabel">Initializing research...</p>
                    </div>
                    <div class="text-sm font-medium" id="progressPercentage">0%</div>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-6">
                    <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progressSteps" class="space-y-1 mb-6">
                    <!-- Timeline steps will be added here dynamically -->
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4 max-h-[420px] overflow-y-auto" id="streamingOutput">
                    <div class="text-sm font-sans text-gray-800 dark:text-gray-200 leading-relaxed markdown-content typing-animation">Initializing research process...</div>
                </div>
                <button id="cancelResearch" class="text-red-500 hover:text-red-700 text-sm font-medium mt-2 flex items-center transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="m15 9-6 6"></path>
                        <path d="m9 9 6 6"></path>
                    </svg>
                    Cancel Research
                </button>
            </section>

            <!-- Research Results Section (Initially Hidden) -->
            <section id="researchResults" class="hidden space-y-8 transition-all duration-300">
                <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                            Research Summary
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button id="copyResults" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                                </svg>
                                Copy
                            </button>
                            <button id="downloadResults" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" x2="12" y1="15" y2="3"></line>
                                </svg>
                                Save as Markdown
                            </button>
                        </div>
                    </div>
                    <div id="researchContent" class="markdown-content pt-2 border-t border-gray-200 dark:border-gray-700"></div>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md md:w-1/2">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m9 18 6-6-6-6"></path>
                            </svg>
                            Research Stats
                        </h3>
                        <div class="space-y-4" id="researchStats">
                            <!-- Will be filled dynamically -->
                        </div>
                    </div>
                    <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md md:w-1/2">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 3c-1.2 0-2.4.6-3 1.7A4 4 0 0 0 4 9c0 1 .6 2.2 1.3 3.2a18 18 0 0 0 5.2 5.2 4 4 0 0 0 6.1-6.1 18 18 0 0 0-5.2-5.2A10 10 0 0 0 12 3z"></path>
                            </svg>
                            Key Insights
                        </h3>
                        <div class="space-y-2" id="keyInsights">
                            <!-- Will be filled dynamically -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="newResearch" class="mt-2 bg-primary hover:bg-primaryDark text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 12h18"></path>
                            <path d="M12 3v18"></path>
                        </svg>
                        Start New Research
                    </button>
                </div>
            </section>
        </main>

        <footer class="border-t border-gray-200 dark:border-gray-800 py-6">
            <div class="container max-w-6xl mx-auto px-4 text-center text-sm text-gray-500 dark:text-gray-400">
                <p>Advanced Research Agent</p>
            </div>
        </footer>
    </div>

    <script>
        // Set up dark mode based on system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // DOM elements
        const themeToggle = document.getElementById('themeToggle');
        const startResearchBtn = document.getElementById('startResearch');
        const newResearchBtn = document.getElementById('newResearch');
        const cancelResearchBtn = document.getElementById('cancelResearch');
        const copyResultsBtn = document.getElementById('copyResults');
        const downloadResultsBtn = document.getElementById('downloadResults');
        const researchTopicInput = document.getElementById('researchTopic');
        const researchDepthSelect = document.getElementById('researchDepth');
        const researchProgress = document.getElementById('researchProgress');
        const progressSteps = document.getElementById('progressSteps');
        const streamingOutput = document.getElementById('streamingOutput');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const currentStepLabel = document.getElementById('currentStepLabel');
        const elapsedTime = document.getElementById('elapsedTime');
        const researchResults = document.getElementById('researchResults');
        const researchContent = document.getElementById('researchContent');
        const researchStats = document.getElementById('researchStats');
        const keyInsights = document.getElementById('keyInsights');
        const advancedSettingsToggle = document.getElementById('advancedSettingsToggle');
        const advancedSettings = document.getElementById('advancedSettings');
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperatureValue');
        
        // Research state
        let currentResearchPlan = [];
        let currentResearchStep = 0;
        let researchResponses = [];
        let isResearchInProgress = false;
        let startTime = null;
        let elapsedTimeInterval = null;
        let streamingInterval = null;
        let abortController = null;
        
        // Toggle theme
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });
        
        // Toggle advanced settings
        advancedSettingsToggle.addEventListener('click', () => {
            advancedSettings.classList.toggle('hidden');
            advancedSettingsToggle.textContent = advancedSettings.classList.contains('hidden') 
                ? 'Show Advanced Settings' 
                : 'Hide Advanced Settings';
        });
        
        // Update temperature value display
        temperatureSlider.addEventListener('input', () => {
            temperatureValue.textContent = temperatureSlider.value;
        });
        
        // Start research button click handler
        startResearchBtn.addEventListener('click', async () => {
            const researchTopic = researchTopicInput.value.trim();
            
            if (!researchTopic) {
                showError('Please enter a research topic');
                return;
            }
            
            if (isResearchInProgress) {
                return;
            }
            
            // Reset previous research
            currentResearchPlan = [];
            currentResearchStep = 0;
            researchResponses = [];
            progressSteps.innerHTML = '';
            streamingOutput.innerHTML = '<p class="text-sm font-mono typing-animation">Initializing research process...</p>';
            isResearchInProgress = true;
            abortController = new AbortController();
            
            // Reset and start timer
            startTime = Date.now();
            if (elapsedTimeInterval) clearInterval(elapsedTimeInterval);
            elapsedTimeInterval = setInterval(updateElapsedTime, 1000);
            
            // Show progress section, hide results
            researchProgress.classList.remove('hidden');
            researchResults.classList.add('hidden');
            
            // Disable start button
            startResearchBtn.disabled = true;
            startResearchBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creating Research Plan...
            `;
            
            // Update progress
            updateProgress(0, 'Planning Research');
            
            // Generate research plan
            try {
                // Add initial step in timeline
                addTimelineStep('Planning Research', 'Creating a detailed research plan...', 'in-progress');
                
                const planPrompt = createPlanningPrompt(researchTopic, researchDepthSelect.value);
                const planResponse = await fetchWithStreaming('/api/research/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: researchTopic,
                        depth: researchDepthSelect.value,
                        style: document.getElementById('researchStyle').value,
                        model: document.getElementById('modelSelector').value,
                        temperature: parseFloat(temperatureSlider.value),
                        maxTokens: parseInt(document.getElementById('maxTokens').value)
                    }),
                    signal: abortController.signal
                }, handleStreamingPlanUpdate);
                
                if (!planResponse || planResponse.error) {
                    throw new Error(planResponse?.error || 'Failed to create research plan');
                }
                
                await handlePlanningResponse(planResponse);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Research planning aborted');
                } else {
                    handleError('Error starting research', error);
                }
            }
        });
        
        // Cancel research button click handler
        cancelResearchBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            
            // Clear intervals
            if (elapsedTimeInterval) {
                clearInterval(elapsedTimeInterval);
                elapsedTimeInterval = null;
            }
            
            if (streamingInterval) {
                clearInterval(streamingInterval);
                streamingInterval = null;
            }
            
            // Update UI
            isResearchInProgress = false;
            researchProgress.classList.add('hidden');
            
            // Reset buttons
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            
            showNotification('Research canceled', 'info');
        });
        
        // New research button click handler
        newResearchBtn.addEventListener('click', () => {
            researchResults.classList.add('hidden');
            researchProgress.classList.add('hidden');
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            
            // Don't clear the input so users can refine their prompt
            // researchTopicInput.value = '';
            isResearchInProgress = false;
        });
        
        // Copy results button click handler
        copyResultsBtn.addEventListener('click', () => {
            const content = researchContent.textContent;
            navigator.clipboard.writeText(content)
                .then(() => showNotification('Research results copied to clipboard', 'success'))
                .catch(err => showError('Failed to copy: ' + err));
        });
        
        // Download results button click handler
        downloadResultsBtn.addEventListener('click', () => {
            // This doesn't actually download a file since file downloads aren't supported.
            // Instead, we'll show the markdown source so users can manually copy it
            
            const content = researchContent.getAttribute('data-markdown') || researchContent.textContent;
            
            // Create a modal with the markdown content
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] flex flex-col">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Markdown Source</h3>
                        <button class="close-modal text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto">
                        <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">Copy this markdown and save to a .md file:</p>
                        <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg text-sm font-mono overflow-auto whitespace-pre-wrap max-h-[calc(80vh-180px)]">${content}</pre>
                    </div>
                    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                        <button class="copy-markdown bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded-md">
                            Copy Markdown
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle close modal
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Handle copy button
            modal.querySelector('.copy-markdown').addEventListener('click', () => {
                navigator.clipboard.writeText(content)
                    .then(() => {
                        showNotification('Markdown copied to clipboard', 'success');
                        document.body.removeChild(modal);
                    })
                    .catch(err => showError('Failed to copy: ' + err));
            });
            
            // Close when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        });
        
        // Fetch with streaming support
        async function fetchWithStreaming(url, options, onStreamUpdate) {
            try {
                // In the real app this would make an actual fetch request
                // Here we'll simulate the API for the example
                
                // Start streaming simulation
                let streamContent = '';
                
                if (streamingInterval) {
                    clearInterval(streamingInterval);
                }
                
                // This simulates streaming updates from the server
                return new Promise((resolve, reject) => {
                    try {
                        const { topic, depth } = JSON.parse(options.body);
                        
                        // Simulate different endpoints
                        if (url.includes('/plan')) {
                            simulateResearchPlan(topic, depth, onStreamUpdate, resolve, options.signal);
                        } else if (url.includes('/research')) {
                            const { step } = JSON.parse(options.body);
                            simulateResearchStep(topic, step, onStreamUpdate, resolve, options.signal);
                        } else if (url.includes('/synthesize')) {
                            simulateSynthesis(topic, currentResearchPlan, researchResponses, onStreamUpdate, resolve, options.signal);
                        }
                        
                        // Listen for abort signal
                        options.signal?.addEventListener('abort', () => {
                            if (streamingInterval) {
                                clearInterval(streamingInterval);
                                streamingInterval = null;
                            }
                            reject(new DOMException('Aborted', 'AbortError'));
                        });
                    } catch (error) {
                        if (streamingInterval) {
                            clearInterval(streamingInterval);
                            streamingInterval = null;
                        }
                        reject(error);
                    }
                });
            } catch (error) {
                throw error;
            }
        }
        
        // Simulated API responses
        function simulateResearchPlan(topic, depth, onStreamUpdate, resolve, signal) {
            let streamContent = '';
            const chunks = [
                '{"title": "',
                `Comprehensive Analysis of ${topic}`,
                '", "steps": [',
                '{"id": 1, "title": "Historical Context and Background", "description": "Research the historical development and background of the topic", "key_questions": ["What are the origins?", "How has it evolved over time?", "What were significant milestones?"]},',
                '{"id": 2, "title": "Current State Analysis", "description": "Assess the present situation and recent developments", "key_questions": ["What is the current landscape?", "What are the latest developments?", "Who are the key players?"]},',
                '{"id": 3, "title": "Key Challenges and Issues", "description": "Identify critical problems and obstacles", "key_questions": ["What major challenges exist?", "What controversies are associated?", "What are potential roadblocks?"]},',
                '{"id": 4, "title": "Technological and Scientific Aspects", "description": "Analyze scientific foundations and technological implementations", "key_questions": ["What technologies are involved?", "What scientific principles underpin this topic?", "What innovations are emerging?"]},',
                '{"id": 5, "title": "Economic and Market Implications", "description": "Evaluate economic impacts and market dynamics", "key_questions": ["What is the economic significance?", "How does it affect markets?", "What are the business opportunities?"]},',
                '{"id": 6, "title": "Social and Cultural Impact", "description": "Assess effects on society and culture", "key_questions": ["How does it affect different communities?", "What cultural shifts has it caused?", "How has public perception evolved?"]},',
                '{"id": 7, "title": "Future Trends and Predictions", "description": "Forecast upcoming developments and future directions", "key_questions": ["What are expected future trends?", "How might it evolve in coming years?", "What potential disruptions could occur?"]}'
            ];
            
            if (depth === 'quick') {
                chunks.splice(5, 2); // Remove 2 steps for quick research
            } else if (depth === 'comprehensive') {
                chunks.push(',');
                chunks.push('{"id": 8, "title": "Case Studies and Examples", "description": "Examine specific implementations and real-world examples", "key_questions": ["What successful implementations exist?", "What failures or cautionary tales are documented?", "What lessons can be learned from these cases?"]},');
                chunks.push('{"id": 9, "title": "Regulatory and Policy Framework", "description": "Analyze legal, regulatory, and policy aspects", "key_questions": ["What regulations govern this area?", "How do policies vary across regions?", "What regulatory changes are anticipated?"]}');
            }
            
            chunks.push(']}');
            
            let chunkIndex = 0;
            
            streamingInterval = setInterval(() => {
                if (signal?.aborted) {
                    clearInterval(streamingInterval);
                    return;
                }
                
                if (chunkIndex < chunks.length) {
                    streamContent += chunks[chunkIndex];
                    onStreamUpdate(streamContent);
                    chunkIndex++;
                } else {
                    clearInterval(streamingInterval);
                    
                    try {
                        // Finalize with the complete response
                        const jsonResponse = JSON.parse(streamContent);
                        resolve(jsonResponse);
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                        resolve({ error: "Failed to parse research plan" });
                    }
                }
            }, 300);
        }
        
        function simulateResearchStep(topic, step, onStreamUpdate, resolve, signal) {
            // Create simulated research content based on the step
            const researchContent = [];
            
            switch (step.title.toLowerCase().split(' ')[0]) {
                case 'historical':
                    researchContent.push(`# Historical Context and Background of ${topic}\n\n`);
                    researchContent.push(`The concept of ${topic} has evolved significantly over time. `);
                    researchContent.push(`Initially emerging in the early stages as a theoretical framework, `);
                    researchContent.push(`it has transformed through several distinct phases of development.\n\n`);
                    researchContent.push(`## Origins\n\n`);
                    researchContent.push(`The origins can be traced back to pioneering work in the field, `);
                    researchContent.push(`with early contributors establishing fundamental principles that `);
                    researchContent.push(`would later become central to understanding the topic. `);
                    researchContent.push(`These foundational elements include:\n\n`);
                    researchContent.push(`- Theoretical frameworks developed in academic settings\n`);
                    researchContent.push(`- Early practical applications that demonstrated potential\n`);
                    researchContent.push(`- Interdisciplinary approaches that enriched the concept\n\n`);
                    researchContent.push(`## Evolution Timeline\n\n`);
                    researchContent.push(`- **Early Phase (1970s-1980s)**: Conceptual development and theoretical groundwork\n`);
                    researchContent.push(`- **Growth Phase (1990s-2000s)**: Expanded applications and methodological refinement\n`);
                    researchContent.push(`- **Maturation Phase (2010s)**: Integration with other domains and practical standardization\n`);
                    researchContent.push(`- **Current Phase (2020s)**: Advanced implementations and specialized applications\n\n`);
                    researchContent.push(`## Key Milestones\n\n`);
                    researchContent.push(`Several breakthrough moments have defined the trajectory of ${topic}:\n\n`);
                    researchContent.push(`1. The publication of seminal research papers establishing core principles\n`);
                    researchContent.push(`2. Development of standardized methodologies enabling consistent application\n`);
                    researchContent.push(`3. Technological advances that expanded practical capabilities\n`);
                    researchContent.push(`4. Formation of dedicated professional organizations and research communities\n`);
                    break;
                    
                case 'current':
                    researchContent.push(`# Current State Analysis of ${topic}\n\n`);
                    researchContent.push(`The present landscape of ${topic} is characterized by rapid evolution `);
                    researchContent.push(`and increasing integration across various sectors. Recent developments `);
                    researchContent.push(`have significantly expanded both theoretical understanding and practical applications.\n\n`);
                    researchContent.push(`## Latest Developments\n\n`);
                    researchContent.push(`Recent advancements in ${topic} include:\n\n`);
                    researchContent.push(`- Introduction of improved methodologies that enhance effectiveness\n`);
                    researchContent.push(`- Integration with complementary technologies creating synergistic effects\n`);
                    researchContent.push(`- Expansion into previously unexplored domains and use cases\n`);
                    researchContent.push(`- Refinement of best practices based on accumulated experience\n\n`);
                    researchContent.push(`## Key Players\n\n`);
                    researchContent.push(`The field is shaped by contributions from several types of entities:\n\n`);
                    researchContent.push(`### Academic Institutions\n`);
                    researchContent.push(`Universities and research centers continue to drive theoretical innovation through dedicated research programs.\n\n`);
                    researchContent.push(`### Industry Leaders\n`);
                    researchContent.push(`Major companies have established specialized divisions focused on developing and implementing advanced solutions.\n\n`);
                    researchContent.push(`### Specialized Organizations\n`);
                    researchContent.push(`Dedicated entities have emerged that focus exclusively on specific aspects or applications.\n\n`);
                    researchContent.push(`### Government Agencies\n`);
                    researchContent.push(`Public sector involvement has increased, particularly in areas related to standardization and public applications.\n\n`);
                    break;
                    
                case 'key':
                    researchContent.push(`# Key Challenges and Issues in ${topic}\n\n`);
                    researchContent.push(`Despite significant progress, ${topic} faces several critical challenges `);
                    researchContent.push(`that impede further development and widespread adoption. These issues `);
                    researchContent.push(`range from technical limitations to broader societal concerns.\n\n`);
                    researchContent.push(`## Major Technical Challenges\n\n`);
                    researchContent.push(`1. **Scalability Constraints**: Difficulties in scaling solutions to handle larger volumes or more complex scenarios\n`);
                    researchContent.push(`2. **Integration Complexity**: Challenges in seamlessly integrating with existing systems and workflows\n`);
                    researchContent.push(`3. **Technical Limitations**: Fundamental constraints that currently restrict certain capabilities\n`);
                    researchContent.push(`4. **Performance Optimization**: Balancing effectiveness with efficiency in resource utilization\n\n`);
                    researchContent.push(`## Controversies and Ethical Concerns\n\n`);
                    researchContent.push(`Several contentious issues have emerged around ${topic}:\n\n`);
                    researchContent.push(`- Questions about appropriate use and potential misapplication\n`);
                    researchContent.push(`- Debates regarding ownership, control, and access rights\n`);
                    researchContent.push(`- Concerns about unintended consequences and secondary effects\n`);
                    researchContent.push(`- Disagreements about governance and oversight mechanisms\n\n`);
                    researchContent.push(`## Implementation Roadblocks\n\n`);
                    researchContent.push(`Organizations attempting to implement ${topic} frequently encounter:\n\n`);
                    researchContent.push(`- **Resource Constraints**: Limited availability of necessary expertise and infrastructure\n`);
                    researchContent.push(`- **Resistance to Change**: Organizational inertia and reluctance to adopt new approaches\n`);
                    researchContent.push(`- **Knowledge Gaps**: Insufficient understanding of requirements and implications\n`);
                    researchContent.push(`- **Regulatory Uncertainty**: Unclear or evolving regulatory frameworks\n\n`);
                    break;
                    
                // Add more cases for other research steps
                
                default:
                    // Generic research content for other steps
                    researchContent.push(`# ${step.title} for ${topic}\n\n`);
                    researchContent.push(`This section explores ${step.description.toLowerCase()}.\n\n`);
                    researchContent.push(`## Key Findings\n\n`);
                    researchContent.push(`Based on comprehensive analysis, several important aspects have been identified:\n\n`);
                    researchContent.push(`1. The ${topic} demonstrates significant relationships with related concepts\n`);
                    researchContent.push(`2. Multiple factors influence development and implementation in this area\n`);
                    researchContent.push(`3. Emerging patterns suggest important future directions\n`);
                    researchContent.push(`4. Both opportunities and challenges characterize the current landscape\n\n`);
                    researchContent.push(`## Detailed Analysis\n\n`);
                    researchContent.push(`When examining this aspect in detail, several components merit special attention:\n\n`);
                    researchContent.push(`### Component One\n`);
                    researchContent.push(`This element represents a fundamental aspect that influences overall functioning and effectiveness.\n\n`);
                    researchContent.push(`### Component Two\n`);
                    researchContent.push(`Secondary factors interact with primary elements to create complex relationships and dependencies.\n\n`);
                    researchContent.push(`### Component Three\n`);
                    researchContent.push(`Peripheral considerations nonetheless have significant implications for comprehensive understanding.\n\n`);
                    break;
            }
            
            let chunkIndex = 0;
            
            streamingInterval = setInterval(() => {
                if (signal?.aborted) {
                    clearInterval(streamingInterval);
                    return;
                }
                
                if (chunkIndex < researchContent.length) {
                    onStreamUpdate(researchContent.slice(0, chunkIndex + 1).join(''));
                    chunkIndex++;
                } else {
                    clearInterval(streamingInterval);
                    resolve(researchContent.join(''));
                }
            }, 200);
        }
        
        function simulateSynthesis(topic, plan, responses, onStreamUpdate, resolve, signal) {
            const synthesisContent = [];
            
            // Add detailed error logging
            console.log("Starting synthesis with plan:", plan ? 
                `Valid object with ${plan.steps ? plan.steps.length : 0} steps` : 
                "Invalid plan (null/undefined)");
            console.log("Current research plan:", currentResearchPlan ? 
                `Valid object with ${currentResearchPlan.steps ? currentResearchPlan.steps.length : 0} steps` : 
                "Invalid plan (null/undefined)");
            
            // Check if plan is valid and has steps
            if (!plan || !plan.steps || !Array.isArray(plan.steps) || plan.steps.length === 0) {
                console.error("Invalid research plan for synthesis, attempting to fallback");
                
                // Try using currentResearchPlan as fallback
                if (currentResearchPlan && currentResearchPlan.steps && 
                    Array.isArray(currentResearchPlan.steps) && currentResearchPlan.steps.length > 0) {
                    console.log("Using currentResearchPlan as fallback");
                    plan = {...currentResearchPlan}; // Clone to avoid reference issues
                } else {
                    // Create a default plan if neither is valid
                    console.log("Creating default research plan structure");
                    plan = {
                        steps: [
                            {id: 1, title: "Historical Context and Background"},
                            {id: 2, title: "Current State Analysis"},
                            {id: 3, title: "Key Challenges and Issues"},
                            {id: 4, title: "Future Trends and Predictions"}
                        ]
                    };
                }
            }
            
            synthesisContent.push(`# Comprehensive Analysis: ${topic}\n\n`);
            synthesisContent.push(`## Executive Summary\n\n`);
            synthesisContent.push(`This report presents a comprehensive analysis of ${topic}, examining its historical context, current state, challenges, technological aspects, economic implications, social impact, and future trends. The research reveals that ${topic} is a multifaceted subject with significant implications across various domains. Key findings indicate both substantial opportunities and notable challenges that require careful consideration.\n\n`);
            synthesisContent.push(`## 1. Introduction\n\n`);
            synthesisContent.push(`${topic} represents an area of growing importance in contemporary contexts. This research was conducted to provide a comprehensive understanding of its various dimensions, current status, and potential future developments. The following sections present the findings organized by thematic areas.\n\n`);
            
            // Add sections based on research steps
            for (let i = 0; i < plan.steps.length; i++) {
                const step = plan.steps[i];
                // Ensure step has a title
                const stepTitle = step.title || `Research Area ${i + 1}`;
                const sectionNumber = i + 2; // Section numbering starts from 2 since we have Intro as section 1
                synthesisContent.push(`## ${sectionNumber}. ${stepTitle}\n\n`);
                
                // Add synthesized content from responses
                if (responses && responses[i]) {
                    // Extract key points from the research response
                    const lines = responses[i].split('\n');
                    let extractedSubsections = [];
                    let currentSubsection = '';
                    let currentSubsectionContent = [];
                    let pointsAdded = 0;
                    
                    // First pass: extract subsections with their content
                    for (let j = 0; j < lines.length; j++) {
                        const line = lines[j];
                        
                        // Check if this is a subsection header (###)
                        if (line.startsWith('### ')) {
                            // If we were already collecting a subsection, save it
                            if (currentSubsection) {
                                extractedSubsections.push({
                                    title: currentSubsection,
                                    content: currentSubsectionContent
                                });
                            }
                            
                            // Start a new subsection
                            currentSubsection = line.replace(/^### /, '').trim();
                            currentSubsectionContent = [];
                        } 
                        // Don't include ## headers as they might conflict with main section headers
                        else if (!line.startsWith('## ') && currentSubsection) {
                            currentSubsectionContent.push(line);
                        }
                    }
                    
                    // Save the last subsection if there is one
                    if (currentSubsection) {
                        extractedSubsections.push({
                            title: currentSubsection,
                            content: currentSubsectionContent
                        });
                    }
                    
                    // If we found subsections, use them
                    if (extractedSubsections.length > 0) {
                        // Add up to 3 subsections to keep the report concise
                        const subsectionsToAdd = extractedSubsections.slice(0, 3);
                        
                        for (const subsection of subsectionsToAdd) {
                            synthesisContent.push(`### ${subsection.title}\n\n`);
                            
                            // Filter for bullet points and numbered items
                            const bulletPoints = subsection.content.filter(line => 
                                line.trim().startsWith('- ') || 
                                line.trim().startsWith('* ') || 
                                line.trim().match(/^\d+\.\s/) !== null
                            );
                            
                            // Add up to 3 bullet points
                            if (bulletPoints.length > 0) {
                                const pointsToAdd = bulletPoints.slice(0, 3);
                                for (const point of pointsToAdd) {
                                    synthesisContent.push(`${point}\n\n`);
                                }
                            } else {
                                // If no bullet points, add a generic paragraph
                                synthesisContent.push(`This area examines important aspects of ${topic} related to ${subsection.title.toLowerCase()}. The analysis reveals noteworthy patterns and relationships that contribute to the overall understanding of the topic.\n\n`);
                            }
                        }
                    } else {
                        // If no subsections were found, add generic content
                        synthesisContent.push(`Analysis of this aspect reveals important insights into how ${topic} relates to ${stepTitle.toLowerCase()}. Multiple factors influence developments in this area, with significant implications for overall understanding and practical applications.\n\n`);
                    }
                } else {
                    synthesisContent.push(`This aspect of ${topic} requires further investigation to develop a comprehensive understanding. Initial analysis suggests important relationships with other dimensions examined in this research.\n\n`);
                }
            }
            
            // Calculate the correct section numbers for the final sections
            const insightsSecNum = plan.steps.length + 2;
            const conclusionSecNum = plan.steps.length + 3;
            
            synthesisContent.push(`## ${insightsSecNum}. Key Insights and Recommendations\n\n`);
            synthesisContent.push(`Based on the comprehensive analysis conducted, several key insights and recommendations can be identified:\n\n`);
            synthesisContent.push(`### Key Insights\n\n`);
            synthesisContent.push(`1. ${topic} demonstrates complex interconnections across multiple domains, necessitating interdisciplinary approaches\n`);
            synthesisContent.push(`2. Historical development reveals patterns that continue to influence current applications and understanding\n`);
            synthesisContent.push(`3. Technical and scientific foundations are evolving rapidly, creating both opportunities and implementation challenges\n`);
            synthesisContent.push(`4. Economic and social dimensions are increasingly recognized as critical to successful outcomes\n\n`);
            synthesisContent.push(`### Recommendations\n\n`);
            synthesisContent.push(`1. **Integrated Approach**: Develop strategies that address multiple dimensions simultaneously\n`);
            synthesisContent.push(`2. **Knowledge Development**: Invest in closing identified knowledge gaps through targeted research\n`);
            synthesisContent.push(`3. **Collaborative Frameworks**: Establish mechanisms for cross-sector collaboration\n`);
            synthesisContent.push(`4. **Adaptive Planning**: Implement flexible approaches that can accommodate emerging developments\n\n`);
            synthesisContent.push(`## ${conclusionSecNum}. Conclusion\n\n`);
            synthesisContent.push(`This research has provided a comprehensive examination of ${topic}, revealing its multifaceted nature and significant implications. While substantial progress has been made in understanding and implementing related concepts, important challenges remain. Future developments will likely be shaped by continuing technological innovation, evolving regulatory frameworks, and shifting societal needs and expectations. Continued monitoring and analysis of these factors will be essential for effective engagement with ${topic} moving forward.\n\n`);
            
            let chunkIndex = 0;
            
            streamingInterval = setInterval(() => {
                if (signal?.aborted) {
                    clearInterval(streamingInterval);
                    return;
                }
                
                if (chunkIndex < synthesisContent.length) {
                    onStreamUpdate(synthesisContent.slice(0, chunkIndex + 1).join(''));
                    chunkIndex++;
                } else {
                    clearInterval(streamingInterval);
                    resolve(synthesisContent.join(''));
                }
            }, 150);
        }
        
        // Planning prompt creator
        function createPlanningPrompt(topic, depth) {
            const depthDetails = {
                'quick': '3-5 specific research subtasks',
                'standard': '5-7 specific research subtasks',
                'comprehensive': '7-10 specific research subtasks'
            };
            
            const selectedStyle = document.getElementById('researchStyle').value;
            let stylePrefix = '';
            
            if (selectedStyle === 'academic') {
                stylePrefix = `As an academic researcher, `;
            } else if (selectedStyle === 'journalistic') {
                stylePrefix = `As an investigative journalist, `;
            } else if (selectedStyle === 'strategic') {
                stylePrefix = `As a strategic analyst, `;
            } else if (selectedStyle === 'technical') {
                stylePrefix = `As a technical specialist, `;
            }
            
            return `${stylePrefix}You are a research planning agent. I need you to create a research plan for the topic: "${topic}".

Based on ${depthDetails[depth]}, break down this topic into a focused research plan.

Your response must strictly follow this format as valid JSON without any explanation or additional text:
{
  "title": "Research title",
  "steps": [
    {
      "id": 1,
      "title": "Step 1 title",
      "description": "What needs to be researched in this step",
      "key_questions": ["Question 1", "Question 2"]
    },
    {
      "id": 2,
      "title": "Step 2 title",
      "description": "What needs to be researched in this step",
      "key_questions": ["Question 1", "Question 2"]
    }
  ]
}

Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`).`;
        }
        
        // Streaming update handlers
        function handleStreamingPlanUpdate(content) {
            streamingOutput.innerHTML = `<div class="text-sm font-sans text-gray-800 dark:text-gray-200 leading-relaxed"><pre class="bg-gray-200 dark:bg-gray-700 p-3 rounded overflow-auto">${content}</pre></div>`;
            streamingOutput.scrollTop = streamingOutput.scrollHeight;
        }
        
        function handleStreamingResearchUpdate(content) {
            streamingOutput.innerHTML = `<div class="text-sm font-sans text-gray-800 dark:text-gray-200 leading-relaxed markdown-content">${marked.parse(content)}</div>`;
            streamingOutput.scrollTop = streamingOutput.scrollHeight;
        }
        
        // Handlers for API responses
        async function handlePlanningResponse(planData) {
            // Update progress UI based on response status
            if (!planData || planData.error) {
                updateTimelineStep(0, 'Planning Research', `Error: ${planData?.error || 'Unknown error'}`, 'error');
                startResearchBtn.disabled = false;
                startResearchBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    Start Comprehensive Research
                `;
                isResearchInProgress = false;
                return;
            } 
            
            try {
                // Set research plan
                currentResearchPlan = planData;
                updateTimelineStep(0, 'Planning Research', 'Research plan created successfully', 'complete');
                
                // Update progress percentage
                updateProgress(5, 'Research Plan Created');
                
                // Add steps to timeline UI
                currentResearchPlan.steps.forEach((step, index) => {
                    addTimelineStep(`Step ${step.id}: ${step.title}`, 'Waiting to start...', 'waiting');
                });
                
                // Add final synthesis step
                addTimelineStep('Synthesizing Research', 'Waiting to collect all research data...', 'waiting');
                
                // Start first research step
                await startNextResearchStep();
            } catch (error) {
                updateTimelineStep(0, 'Planning Research', 'Error parsing research plan', 'error');
                console.error("Error processing research plan:", error);
                startResearchBtn.disabled = false;
                startResearchBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    Start Comprehensive Research
                `;
                isResearchInProgress = false;
            }
        }
        
        async function handleResearchStepResponse(response, stepIndex) {
            // Check if the research plan and step are valid
            if (!currentResearchPlan || !currentResearchPlan.steps || !Array.isArray(currentResearchPlan.steps) || 
                stepIndex < 0 || stepIndex >= currentResearchPlan.steps.length) {
                console.error("Invalid research plan or step index:", stepIndex, currentResearchPlan);
                handleError("Error processing research step", new Error("Invalid research step or plan structure"));
                return;
            }
            
            // Get step info, with fallbacks in case properties are missing
            const stepId = currentResearchPlan.steps[stepIndex].id || (stepIndex + 1);
            const stepTitle = currentResearchPlan.steps[stepIndex].title || `Research Area ${stepIndex + 1}`;
            
            if (!response) {
                updateTimelineStep(stepIndex + 1, 
                    `Step ${stepId}: ${stepTitle}`, 
                    `Error: Failed to complete research`, 'error');
                isResearchInProgress = false;
                return;
            } 
            
            // Store response and update UI
            researchResponses[stepIndex] = response;
            updateTimelineStep(stepIndex + 1, 
                `Step ${stepId}: ${stepTitle}`, 
                'Research complete', 'complete');
            
            // Update progress
            const progressPercent = 5 + Math.round((stepIndex + 1) * (85 / currentResearchPlan.steps.length));
            updateProgress(progressPercent, `Completed Step ${stepIndex + 1} of ${currentResearchPlan.steps.length}`);
            
            // Move to next step
            currentResearchStep++;
            if (currentResearchStep < currentResearchPlan.steps.length) {
                await startNextResearchStep();
            } else {
                // All research steps complete, start synthesis
                await startSynthesis();
            }
        }
        
        async function handleSynthesisResponse(response) {
            const synthesisStep = currentResearchPlan.steps.length + 1;
            
            if (!response) {
                updateTimelineStep(synthesisStep, 'Synthesizing Research', 
                    `Error: Failed to synthesize research`, 'error');
                isResearchInProgress = false;
                return;
            } 
            
            updateTimelineStep(synthesisStep, 'Synthesizing Research', 
                'Research synthesis complete', 'complete');
            
            // Update progress
            updateProgress(100, 'Research Complete');
            
            // Display research results
            researchContent.innerHTML = marked.parse(response);
            researchContent.setAttribute('data-markdown', response);
            
            // Generate research stats
            generateResearchStats();
            
            // Generate key insights
            generateKeyInsights(response);
            
            // Show results section
            researchResults.classList.remove('hidden');
            
            // Clear intervals
            if (elapsedTimeInterval) {
                clearInterval(elapsedTimeInterval);
                elapsedTimeInterval = null;
            }
            
            // Reset UI for next research
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            isResearchInProgress = false;
        }
        
        // Helper functions
        async function startNextResearchStep() {
            if (!isResearchInProgress) return;
            
            const stepIndex = currentResearchStep;
            
            // Check if the research plan and step are valid
            if (!currentResearchPlan || !currentResearchPlan.steps || !Array.isArray(currentResearchPlan.steps) || 
                stepIndex < 0 || stepIndex >= currentResearchPlan.steps.length) {
                console.error("Invalid research plan or step index:", stepIndex, currentResearchPlan);
                handleError("Error researching step", new Error("Invalid research step or plan structure"));
                return;
            }
            
            const step = currentResearchPlan.steps[stepIndex];
            
            // Ensure step has id and title with fallbacks
            const stepId = step.id || (stepIndex + 1);
            const stepTitle = step.title || `Research Area ${stepIndex + 1}`;
            
            // Update UI to show current step as in progress
            updateTimelineStep(stepIndex + 1, 
                `Step ${stepId}: ${stepTitle}`, 
                'Researching...', 'in-progress');
            
            // Update progress text
            updateProgress(5 + Math.round(stepIndex * (85 / currentResearchPlan.steps.length)), 
                `Researching: ${stepTitle}`);
            
            try {
                // Reset streaming output
                streamingOutput.innerHTML = '<p class="text-sm font-mono typing-animation">Initiating research for this step...</p>';
                
                // Fetch research for this step
                const response = await fetchWithStreaming('/api/research/step', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: researchTopicInput.value,
                        step: step,
                        model: document.getElementById('modelSelector').value,
                        temperature: parseFloat(temperatureSlider.value),
                        maxTokens: parseInt(document.getElementById('maxTokens').value)
                    }),
                    signal: abortController.signal
                }, handleStreamingResearchUpdate);
                
                await handleResearchStepResponse(response, stepIndex);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Research step aborted');
                } else {
                    handleError(`Error researching step ${stepIndex + 1}`, error);
                }
            }
        }
        
        async function startSynthesis() {
            if (!isResearchInProgress) return;
            
            // Validate research plan before proceeding
            if (!currentResearchPlan || !currentResearchPlan.steps || !Array.isArray(currentResearchPlan.steps)) {
                console.error("Invalid research plan for synthesis:", currentResearchPlan);
                handleError('Error synthesizing research', new Error("Invalid research plan structure"));
                return;
            }
            
            const synthesisStep = currentResearchPlan.steps.length + 1;
            
            // Update UI
            updateTimelineStep(synthesisStep, 'Synthesizing Research', 
                'Creating comprehensive research report...', 'in-progress');
            
            // Update progress
            updateProgress(90, 'Synthesizing Research Findings');
            
            try {
                // Reset streaming output
                streamingOutput.innerHTML = '<p class="text-sm font-mono typing-animation">Synthesizing comprehensive research report...</p>';
                
                // Log the research plan and responses before synthesis for debugging
                console.log("Starting synthesis with research plan:", 
                    JSON.stringify({
                        stepsCount: currentResearchPlan.steps.length,
                        hasResponses: researchResponses.length > 0
                    })
                );
                
                const response = await fetchWithStreaming('/api/research/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: researchTopicInput.value,
                        depth: researchDepthSelect.value,
                        style: document.getElementById('researchStyle').value,
                        model: document.getElementById('modelSelector').value,
                        temperature: parseFloat(temperatureSlider.value),
                        maxTokens: parseInt(document.getElementById('maxTokens').value)
                    }),
                    signal: abortController.signal
                }, handleStreamingResearchUpdate);
                
                await handleSynthesisResponse(response);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Research synthesis aborted');
                } else {
                    handleError('Error synthesizing research', error);
                }
            }
        }
        
        function generateResearchStats() {
            // Calculate statistics from research responses
            const totalWordCount = researchResponses.reduce((sum, response) => {
                return sum + (response ? response.split(/\s+/).length : 0);
            }, 0);
            
            const elapsedTimeInMinutes = startTime ? Math.round((Date.now() - startTime) / 60000) : 0;
            
            // Generate stats HTML
            researchStats.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-primary">${currentResearchPlan.steps.length}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Research Areas</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-primary">${totalWordCount.toLocaleString()}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Total Words</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-primary">${elapsedTimeInMinutes}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Minutes to Complete</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-primary">${document.getElementById('modelSelector').value === 'deepseek' ? 'DeepSeek v3' : 'Llama 4'}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">AI Model Used</div>
                    </div>
                </div>
                <div class="mt-4 bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
                    <h4 class="text-sm font-medium mb-2">Research Style</h4>
                    <div class="flex items-center">
                        <div class="w-full bg-gray-300 dark:bg-gray-700 rounded-full h-2.5">
                            <div class="bg-primary h-2.5 rounded-full" style="width: ${document.getElementById('researchStyle').value === 'standard' ? '60%' : 
                                                                                document.getElementById('researchStyle').value === 'academic' ? '95%' : 
                                                                                document.getElementById('researchStyle').value === 'journalistic' ? '75%' : '85%'}"></div>
                        </div>
                        <span class="ml-2 text-sm">${document.getElementById('researchStyle').value.charAt(0).toUpperCase() + document.getElementById('researchStyle').value.slice(1)}</span>
                    </div>
                </div>
            `;
        }
        
        function generateKeyInsights(synthesisContent) {
            // Extract insights from synthesis content
            // This is a simple extraction - in a real implementation, you would use more sophisticated NLP
            const insights = [];
            const lines = synthesisContent.split('\n');
            
            let insightSection = false;
            for (const line of lines) {
                if (line.includes('Key Insights') || line.includes('key insights')) {
                    insightSection = true;
                    continue;
                }
                
                if (insightSection && line.startsWith('###')) {
                    insightSection = false;
                }
                
                if (insightSection && (line.startsWith('- ') || line.startsWith('* ') || line.match(/^\d+\.\s/))) {
                    insights.push(line.replace(/^[- *]\d+\.\s*/, '').replace(/^\d+\.\s*/, ''));
                }
            }
            
            // If no insights were found, add default ones
            if (insights.length === 0) {
                insights.push(
                    "The topic demonstrates complex interconnections across multiple domains",
                    "Historical development reveals patterns that influence current understanding",
                    "Technical foundations are evolving rapidly, creating new opportunities",
                    "Economic and social dimensions are increasingly recognized as critical"
                );
            }
            
            // Limit to max 5 insights
            const limitedInsights = insights.slice(0, 5);
            
            // Generate HTML
            keyInsights.innerHTML = limitedInsights.map(insight => `
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 flex items-start">
                    <div class="text-primary mr-3 flex-shrink-0 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m9 18 6-6-6-6"></path>
                        </svg>
                    </div>
                    <p class="text-sm">${insight}</p>
                </div>
            `).join('');
        }
        
        function addTimelineStep(title, description, status) {
            const stepIndex = progressSteps.children.length;
            const step = document.createElement('div');
            step.classList.add('timeline-step', 'relative', 'pl-8', 'pb-6');
            
            const statusIndicator = getStatusIndicator(status);
            const stepContent = `
                <div class="timeline-line"></div>
                <div class="absolute left-0 top-0">
                    ${statusIndicator}
                </div>
                <div class="mb-1 text-sm font-medium">${title}</div>
                <p class="text-xs text-gray-500 dark:text-gray-400 step-description">${description}</p>
            `;
            
            step.innerHTML = stepContent;
            progressSteps.appendChild(step);
        }
        
        function updateTimelineStep(index, title, description, status) {
            const steps = progressSteps.children;
            if (!steps[index]) return;
            
            const step = steps[index];
            
            // Update status indicator
            const statusIndicatorContainer = step.querySelector('.absolute');
            if (statusIndicatorContainer) {
                statusIndicatorContainer.innerHTML = getStatusIndicator(status);
            }
            
            // Update description
            const descriptionElement = step.querySelector('.step-description');
            if (descriptionElement) {
                descriptionElement.textContent = description;
            }
            
            // Update title if needed
            const titleElement = step.querySelector('.text-sm.font-medium');
            if (titleElement && title) {
                titleElement.textContent = title;
            }
        }
        
        function getStatusIndicator(status) {
            switch(status) {
                case 'waiting':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500 dark:text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                    </div>`;
                case 'in-progress':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-primary bg-opacity-20">
                        <svg class="animate-spin h-3 w-3 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>`;
                case 'complete':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-green-100 dark:bg-green-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-green-600 dark:text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 6 9 17l-5-5"></path>
                        </svg>
                    </div>`;
                case 'error':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-red-100 dark:bg-red-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-red-600 dark:text-red-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 6 6 18"></path>
                            <path d="m6 6 12 12"></path>
                        </svg>
                    </div>`;
                default:
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500 dark:text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 16v.01"></path>
                            <path d="M12 8v4"></path>
                        </svg>
                    </div>`;
            }
        }
        
        function updateProgress(percent, statusText) {
            progressBar.style.width = `${percent}%`;
            progressPercentage.textContent = `${percent}%`;
            currentStepLabel.textContent = statusText;
        }
        
        function updateElapsedTime() {
            if (!startTime) return;
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            elapsedTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function handleError(message, error) {
            console.error(`${message}:`, error);
            showError(`${message}: ${error.message || 'Unknown error'}`);
            
            // Reset UI
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            isResearchInProgress = false;
            
            // Clear intervals
            if (elapsedTimeInterval) {
                clearInterval(elapsedTimeInterval);
                elapsedTimeInterval = null;
            }
            
            if (streamingInterval) {
                clearInterval(streamingInterval);
                streamingInterval = null;
            }
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showNotification(message, type = 'info') {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 animate-fade-in transition-opacity duration-500 ${
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            
            const icon = type === 'error' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="m15 9-6 6"></path>
                    <path d="m9 9 6 6"></path>
                </svg>
            ` : type === 'success' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 6 9 17l-5-5"></path>
                </svg>
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v.01"></path>
                    <path d="M12 8v4"></path>
                </svg>
            `;
            
            notificationDiv.innerHTML = `<div class="flex items-center">${icon}<span>${message}</span></div>`;
            
            document.body.appendChild(notificationDiv);
            
            setTimeout(() => {
                notificationDiv.classList.add('opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notificationDiv);
                }, 500);
            }, 4000);
        }
    </script>



</body></html>
