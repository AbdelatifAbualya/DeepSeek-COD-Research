<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Research Agent (MCP Inspired)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
     <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        primaryDark: '#4B4AC9',
                        primaryLight: '#7E7DE8',
                        dark: {
                            bg: '#121212',
                            card: '#1E1E1E',
                            input: '#2D2D2D',
                            text: '#F9FAFB'
                        },
                        light: {
                            bg: '#F9FAFB',
                            card: '#FFFFFF',
                            input: '#F3F4F6',
                            text: '#1F2937'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }
                }
            }
        }
    </script>
    <style>
        /* Markdown styling */
        .markdown-content h1 { font-size: 1.8rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-content h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content h4 { font-size: 1.1rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul, .markdown-content ol { margin-left: 2rem; margin-bottom: 0.75rem; }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content pre { background-color: #f0f0f0; padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 0.75rem; overflow-x: auto; }
        .dark .markdown-content pre { background-color: #2d2d2d; }
        .markdown-content code { font-family: monospace; background-color: rgba(100,100,100,0.1); padding: 0.1rem 0.3rem; border-radius: 0.2rem;}
        .dark .markdown-content code { background-color: rgba(200,200,200,0.1); }
        .markdown-content blockquote { border-left: 4px solid #ddd; padding-left: 1rem; margin-left: 0; margin-bottom: 0.75rem; font-style: italic; color: #6b7280;}
        .dark .markdown-content blockquote { border-left-color: #555; color: #9ca3af; }
        .markdown-content img { max-width: 100%; height: auto; margin: 1rem 0; border-radius: 0.5rem; }
        .markdown-content table { border-collapse: collapse; margin-bottom: 0.75rem; width: 100%; }
        .markdown-content th, .markdown-content td { border: 1px solid #ddd; padding: 0.5rem; }
        .dark .markdown-content th, .dark .markdown-content td { border-color: #555; }

        /* Step timeline indicators */
        .timeline-step { position: relative; padding-left: 2rem; padding-bottom: 1.5rem; }
        .timeline-line { position: absolute; left: 0.75rem; top: 1.5rem; bottom: 0; width: 2px; background-color: #5D5CDE; }
        .timeline-step:last-child .timeline-line { display: none; }
        .timeline-indicator { position: absolute; left: 0; top: 0; width: 1.5rem; height: 1.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; }

        /* Typing animation */
        .typing-animation::after { content: "|"; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.7); }
        .dark ::-webkit-scrollbar-thumb { background: rgba(75, 85, 99, 0.5); }
        .dark ::-webkit-scrollbar-thumb:hover { background: rgba(75, 85, 99, 0.7); }

        /* Added fade-in animation */
         @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* TailwindCSS Custom Forms plugin styles (basic implementation) */
        input[type='checkbox'] {
            border-radius: 0.25rem;
            border-color: #D1D5DB; /* gray-300 */
            color: #5D5CDE; /* primary */
        }
        .dark input[type='checkbox'] {
             border-color: #4B5563; /* gray-600 */
             background-color: #374151; /* gray-700 */
        }
        input[type='checkbox']:checked {
            border-color: transparent;
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
         input[type='checkbox']:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-inset: var(--tw-empty,/*!*/ /*!*/);
            --tw-ring-offset-width: 2px;
            --tw-ring-offset-color: #fff;
            --tw-ring-color: #5D5CDE; /* primary */
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
         }

         select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            appearance: none;
         }
         .dark select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
         }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text transition-colors duration-300 font-sans">
    <div class="min-h-screen flex flex-col">
        <header class="border-b border-gray-200 dark:border-gray-700 bg-light-card dark:bg-dark-card shadow-sm sticky top-0 z-50">
            <div class="container max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                         <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <h1 class="text-xl md:text-2xl font-bold">Advanced Research Agent</h1>
                </div>
                <button id="themeToggle" aria-label="Toggle Dark Mode" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                     <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                     <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </header>

        <main class="flex-1 container max-w-6xl mx-auto px-4 py-8">
            <section id="introCard" class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                 <div class="flex items-center justify-center">
                     <div class="text-center">
                         <div class="flex items-center justify-center mb-4">
                             <div class="rounded-full bg-primary/10 p-3 text-primary mr-3">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                             </div>
                             <h2 class="text-2xl md:text-3xl font-bold">Start Your Research</h2>
                         </div>
                         <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto mb-6">Define your research topic and configure the agent to begin the investigation.</p>
                          <button id="showInputBtn" class="bg-primary hover:bg-primaryDark text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                             Configure Research
                          </button>
                     </div>
                 </div>
            </section>

            <section id="inputSection" class="hidden bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Research Configuration
                </h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                         <label for="researchTopic" class="block text-sm font-medium mb-2">Research Topic</label>
                         <textarea id="researchTopic" rows="4" placeholder="Enter a detailed description of what you'd like to research..." class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/50 focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-600 dark:text-white dark:placeholder-gray-400 transition duration-200"></textarea>
                     </div>
                     <div class="space-y-4">
                         <div>
                             <label for="researchDepth" class="block text-sm font-medium mb-2">Research Depth</label>
                             <select id="researchDepth" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/50 focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-600 dark:text-white transition duration-200">
                                 <option value="quick">Quick (Surface Level)</option>
                                 <option value="standard" selected>Standard (Balanced)</option>
                                 <option value="comprehensive">Comprehensive (In-Depth)</option>
                             </select>
                         </div>
                         <div>
                             <label for="researchStyle" class="block text-sm font-medium mb-2">Report Style</label>
                             <select id="researchStyle" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/50 focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-600 dark:text-white transition duration-200">
                                 <option value="standard" selected>Standard Report</option>
                                 <option value="academic">Academic Paper</option>
                                 <option value="blog_post">Blog Post</option>
                                 <option value="bullet_points">Bullet Point Summary</option>
                             </select>
                         </div>
                     </div>
                 </div>
                 <div class="mt-6">
                     <label class="block text-sm font-medium mb-2">Agent Capabilities (Select tools to enable)</label>
                     <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                         <div class="flex items-center p-3 bg-light-input dark:bg-dark-input rounded-lg border border-gray-300 dark:border-gray-600">
                             <input type="checkbox" id="webSearch" name="agentCapabilities" value="web_search" class="w-4 h-4 text-primary border-gray-400 dark:border-gray-500 rounded focus:ring-primary focus:ring-offset-light-input dark:focus:ring-offset-dark-input mr-2" checked>
                             <label for="webSearch" class="text-sm">Web Search</label>
                         </div>
                         <div class="flex items-center p-3 bg-light-input dark:bg-dark-input rounded-lg border border-gray-300 dark:border-gray-600">
                             <input type="checkbox" id="dataAnalysis" name="agentCapabilities" value="data_analysis" class="w-4 h-4 text-primary border-gray-400 dark:border-gray-500 rounded focus:ring-primary focus:ring-offset-light-input dark:focus:ring-offset-dark-input mr-2" checked>
                             <label for="dataAnalysis" class="text-sm">Data Analysis</label>
                         </div>
                         <div class="flex items-center p-3 bg-light-input dark:bg-dark-input rounded-lg border border-gray-300 dark:border-gray-600">
                             <input type="checkbox" id="fileSystem" name="agentCapabilities" value="filesystem" class="w-4 h-4 text-primary border-gray-400 dark:border-gray-500 rounded focus:ring-primary focus:ring-offset-light-input dark:focus:ring-offset-dark-input mr-2">
                             <label for="fileSystem" class="text-sm">File System Access</label>
                         </div>
                         <div class="flex items-center p-3 bg-light-input dark:bg-dark-input rounded-lg border border-gray-300 dark:border-gray-600">
                             <input type="checkbox" id="githubAccess" name="agentCapabilities" value="github" class="w-4 h-4 text-primary border-gray-400 dark:border-gray-500 rounded focus:ring-primary focus:ring-offset-light-input dark:focus:ring-offset-dark-input mr-2">
                             <label for="githubAccess" class="text-sm">GitHub Access</label>
                         </div>
                          <div class="flex items-center p-3 bg-light-input dark:bg-dark-input rounded-lg border border-gray-300 dark:border-gray-600">
                             <input type="checkbox" id="webScraping" name="agentCapabilities" value="web_scraping" class="w-4 h-4 text-primary border-gray-400 dark:border-gray-500 rounded focus:ring-primary focus:ring-offset-light-input dark:focus:ring-offset-dark-input mr-2">
                             <label for="webScraping" class="text-sm">Web Scraping</label>
                         </div>
                         </div>
                 </div>
                <button id="startResearch" class="w-full mt-6 bg-primary hover:bg-primaryDark text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                         <circle cx="11" cy="11" r="8"></circle>
                         <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                     </svg>
                    Start Research
                </button>
            </section>

            <section id="researchProgress" class="hidden bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Research in Progress
                    </h2>
                    <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 animate-pulse text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span id="elapsedTime">00:00</span>
                    </div>
                </div>
                 <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
                    <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <div class="flex items-center justify-between mb-4 text-sm font-medium">
                     <span id="currentStepLabel" class="text-gray-600 dark:text-gray-300">Initializing research...</span>
                     <span id="progressPercentage" class="text-primary">0%</span>
                </div>
                <div id="progressSteps" class="space-y-1 mb-6 max-h-60 overflow-y-auto pr-2">
                    </div>
                <h3 class="text-lg font-semibold mb-2">Live Agent Log:</h3>
                 <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4 max-h-[420px] overflow-y-auto border border-gray-200 dark:border-gray-700" id="streamingOutput">
                     <div class="text-sm font-mono text-gray-700 dark:text-gray-300 leading-relaxed typing-animation">Waiting for agent activity...</div>
                 </div>
                 <button id="cancelResearch" class="text-red-600 hover:text-red-700 dark:text-red-500 dark:hover:text-red-400 text-sm font-medium mt-2 flex items-center transition-colors duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                         <circle cx="12" cy="12" r="10"></circle>
                         <line x1="15" y1="9" x2="9" y2="15"></line>
                         <line x1="9" y1="9" x2="15" y2="15"></line>
                     </svg>
                     Cancel Research
                 </button>
            </section>

            <section id="researchResults" class="hidden space-y-8 transition-all duration-300">
                <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                         <h2 class="text-2xl font-bold flex items-center text-green-600 dark:text-green-400">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                             Research Complete
                         </h2>
                         <div class="flex items-center space-x-2">
                             <button id="copyResults" aria-label="Copy Results" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                     <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                 </svg>
                                 Copy
                             </button>
                             <button id="downloadResults" aria-label="Save Results as Markdown" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                     <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>
                                 </svg>
                                 Save .md
                             </button>
                         </div>
                    </div>
                    <div id="researchContent" class="markdown-content pt-4 border-t border-gray-200 dark:border-gray-700">
                        <p>Loading final report...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Research Stats
                        </h3>
                        <div class="space-y-4" id="researchStats">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Statistics will appear here.</p>
                        </div>
                    </div>
                    <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            Key Insights
                        </h3>
                        <div class="space-y-2" id="keyInsights">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Key insights will appear here.</p>
                        </div>
                    </div>
                 </div>

                 <div class="flex justify-center">
                     <button id="newResearch" class="mt-4 bg-primary hover:bg-primaryDark text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                             <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                             <path d="M21 3v5h-5"></path>
                             <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                             <path d="M8 16H3v5"></path>
                         </svg>
                         Start New Research
                     </button>
                 </div>
            </section>
        </main>

        <footer class="border-t border-gray-200 dark:border-gray-700 py-6 mt-8">
            <div class="container max-w-6xl mx-auto px-4 text-center text-sm text-gray-500 dark:text-gray-400">
                <p>Advanced Research Agent - Powered by Vercel & MCP Concepts</p>
            </div>
        </footer>
    </div>

    <div id="notificationArea" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // --- Theme Management ---
        const themeToggle = document.getElementById('themeToggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        };

        const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(currentTheme);

        themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        // --- DOM Elements ---
        const showInputBtn = document.getElementById('showInputBtn');
        const introCard = document.getElementById('introCard');
        const inputSection = document.getElementById('inputSection');
        const startResearchBtn = document.getElementById('startResearch');
        const newResearchBtn = document.getElementById('newResearch');
        const cancelResearchBtn = document.getElementById('cancelResearch');
        const copyResultsBtn = document.getElementById('copyResults');
        const downloadResultsBtn = document.getElementById('downloadResults');
        const researchTopicInput = document.getElementById('researchTopic');
        const researchDepthSelect = document.getElementById('researchDepth');
        const researchStyleSelect = document.getElementById('researchStyle');
        const agentCapabilityCheckboxes = document.querySelectorAll('input[name="agentCapabilities"]');

        const researchProgressSection = document.getElementById('researchProgress');
        const progressSteps = document.getElementById('progressSteps');
        const streamingOutput = document.getElementById('streamingOutput');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const currentStepLabel = document.getElementById('currentStepLabel');
        const elapsedTime = document.getElementById('elapsedTime');

        const researchResultsSection = document.getElementById('researchResults');
        const researchContent = document.getElementById('researchContent');
        const researchStats = document.getElementById('researchStats');
        const keyInsights = document.getElementById('keyInsights');
        const notificationArea = document.getElementById('notificationArea');

        // --- State Variables ---
        let isResearchInProgress = false;
        let startTime = null;
        let elapsedTimeInterval = null;
        let abortController = null;
        let currentResearchData = null; // To store final results for copy/download

        // --- Event Listeners ---
        showInputBtn.addEventListener('click', () => {
            introCard.classList.add('hidden');
            inputSection.classList.remove('hidden');
            inputSection.classList.add('animate-fade-in');
        });

        startResearchBtn.addEventListener('click', startResearch);
        cancelResearchBtn.addEventListener('click', cancelResearch);
        newResearchBtn.addEventListener('click', resetUI);
        copyResultsBtn.addEventListener('click', copyResults);
        downloadResultsBtn.addEventListener('click', downloadResults);

        // --- Core Functions ---

        async function startResearch() {
            const researchTopic = researchTopicInput.value.trim();
            if (!researchTopic) {
                showNotification('Please enter a research topic.', 'error');
                return;
            }
            if (isResearchInProgress) return;

            isResearchInProgress = true;
            abortController = new AbortController();
            currentResearchData = null; // Reset previous data

            // Reset UI for progress
            progressSteps.innerHTML = '';
            streamingOutput.innerHTML = '<div class="text-sm font-mono text-gray-700 dark:text-gray-300 leading-relaxed typing-animation">Initializing research process...</div>';
            researchProgressSection.classList.remove('hidden');
            researchProgressSection.classList.add('animate-fade-in');
            researchResultsSection.classList.add('hidden');
            inputSection.classList.add('hidden'); // Hide input section during research
            introCard.classList.add('hidden');

            // Disable start button, show loading state
            startResearchBtn.disabled = true;
            startResearchBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Researching...`;

            // Reset and start timer
            startTime = Date.now();
            updateElapsedTime(); // Initial display
            if (elapsedTimeInterval) clearInterval(elapsedTimeInterval);
            elapsedTimeInterval = setInterval(updateElapsedTime, 1000);

            updateProgress(0, 'Initializing...');
            addTimelineStep('Initiation', 'Starting the research process...', 'in-progress');

            // --- Call Backend API ---
            try {
                const selectedCapabilities = Array.from(agentCapabilityCheckboxes)
                                                 .filter(cb => cb.checked)
                                                 .map(cb => cb.value);

                const response = await fetch('/api/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: researchTopic,
                        depth: researchDepthSelect.value,
                        style: researchStyleSelect.value,
                        capabilities: selectedCapabilities
                        // Add any other parameters your backend expects
                    }),
                    signal: abortController.signal,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown server error' }));
                    throw new Error(`Server error: ${response.status} ${response.statusText}. ${errorData.detail || ''}`);
                }

                if (!response.body) {
                     throw new Error("ReadableStream not yet supported in this browser.");
                }

                // Process stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullLog = ''; // Accumulate logs for the streaming output
                streamingOutput.innerHTML = ''; // Clear initial message


                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Process buffer line by line (assuming newline-delimited JSON chunks)
                    let boundary = buffer.indexOf('\n');
                    while (boundary !== -1) {
                        const chunkString = buffer.substring(0, boundary).trim();
                        buffer = buffer.substring(boundary + 1);

                        if (chunkString) {
                            try {
                                const chunk = JSON.parse(chunkString);
                                processStreamChunk(chunk);

                                // Append log chunk to the streaming output display
                                if (chunk.type === 'log' || chunk.type === 'step_update' || chunk.type === 'progress') {
                                     const logEntry = document.createElement('div');
                                     logEntry.className = 'text-sm font-mono text-gray-700 dark:text-gray-300 leading-relaxed mb-1';
                                     logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${chunk.data.message || chunk.data.status || `${chunk.data.percent}%`}`;
                                     streamingOutput.appendChild(logEntry);
                                     streamingOutput.scrollTop = streamingOutput.scrollHeight; // Auto-scroll
                                } else if (chunk.type === 'final_report') {
                                    // Handle final report separately after loop
                                } else if (chunk.type === 'error') {
                                     const errorEntry = document.createElement('div');
                                     errorEntry.className = 'text-sm font-mono text-red-600 dark:text-red-400 leading-relaxed mb-1';
                                     errorEntry.textContent = `[${new Date().toLocaleTimeString()}] ERROR: ${chunk.data.message}`;
                                     streamingOutput.appendChild(errorEntry);
                                     streamingOutput.scrollTop = streamingOutput.scrollHeight; // Auto-scroll
                                     throw new Error(chunk.data.message); // Stop processing on server error
                                }

                            } catch (e) {
                                console.error("Error parsing stream chunk:", chunkString, e);
                                // Optionally display parsing error in UI
                            }
                        }
                        boundary = buffer.indexOf('\n');
                    }
                }
                 // Process any remaining buffer content if necessary (e.g., final chunk without newline)
                 if (buffer.trim()) {
                     try {
                         const chunk = JSON.parse(buffer.trim());
                         processStreamChunk(chunk);
                         // Handle log display as above
                     } catch (e) {
                         console.error("Error parsing final stream chunk:", buffer.trim(), e);
                     }
                 }


                 // Research considered complete once stream ends, assuming final chunk contains results
                if (currentResearchData) { // Ensure final data was received
                    completeResearch(currentResearchData);
                } else {
                     throw new Error("Research finished, but no final report data was received from the server.");
                }


            } catch (error) {
                 if (error.name === 'AbortError') {
                     console.log('Research fetch aborted.');
                     showNotification('Research cancelled.', 'info');
                     handleResearchEnd(); // Clean up UI state
                 } else {
                     console.error('Research error:', error);
                     showNotification(`Research failed: ${error.message}`, 'error');
                     handleResearchEnd(true); // Clean up UI state, indicate error
                 }
            }
        }

         function processStreamChunk(chunk) {
             // console.log("Received chunk:", chunk); // For debugging
             switch (chunk.type) {
                 case 'progress':
                     updateProgress(chunk.data.percent, chunk.data.status);
                     break;
                 case 'step_update':
                     addTimelineStep(chunk.data.title, chunk.data.description, chunk.data.status);
                     // Update progress label if status changes
                     if (chunk.data.status === 'in-progress') {
                         currentStepLabel.textContent = `Working on: ${chunk.data.title}`;
                     }
                     break;
                 case 'final_report':
                     // Store final data, processing happens after stream closes
                     currentResearchData = chunk.data;
                     break;
                 case 'log':
                     // Log already handled in the reading loop for display
                     break;
                 case 'error':
                      console.error("Server-side error:", chunk.data.message);
                      // Error handled in the reading loop
                      break;
                 default:
                     console.warn("Unknown stream chunk type:", chunk.type);
             }
         }


        function completeResearch(finalData) {
            updateProgress(100, 'Research Complete');
            addTimelineStep('Completion', 'Final report generated.', 'complete');

             // Display final report
             researchContent.innerHTML = marked.parse(finalData.report_markdown || '*No report content provided.*');
             researchContent.setAttribute('data-markdown', finalData.report_markdown || '');

             // Generate stats and insights (adapt based on actual finalData structure)
             generateResearchStats(finalData.stats || {});
             generateKeyInsights(finalData.insights || []);

             // Show results, hide progress
             researchProgressSection.classList.add('hidden');
             researchResultsSection.classList.remove('hidden');
             researchResultsSection.classList.add('animate-fade-in');

            handleResearchEnd();
            showNotification('Research complete!', 'success');
        }


        function cancelResearch() {
            if (isResearchInProgress && abortController) {
                abortController.abort(); // This triggers the 'AbortError' in the fetch catch block
            }
        }

        function handleResearchEnd(errorOccurred = false) {
             isResearchInProgress = false;
             if (elapsedTimeInterval) clearInterval(elapsedTimeInterval);
             elapsedTimeInterval = null;

             // Reset start button
             startResearchBtn.disabled = false;
             startResearchBtn.innerHTML = `
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <circle cx="11" cy="11" r="8"></circle>
                     <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                 </svg>
                 Start Research
             `;

            if (errorOccurred) {
                // Optionally hide progress and show input again on error
                researchProgressSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
                updateTimelineStep(progressSteps.children.length -1, null, 'Research failed', 'error');
            }
        }

        function resetUI() {
             researchResultsSection.classList.add('hidden');
             researchProgressSection.classList.add('hidden');
             inputSection.classList.remove('hidden');
             introCard.classList.remove('hidden'); // Show intro card again
             inputSection.classList.add('hidden'); // Hide input section initially
             handleResearchEnd(); // Ensure button/state is reset
             // researchTopicInput.value = ''; // Optional: Clear input
        }

        function updateElapsedTime() {
            if (!startTime) return;
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            elapsedTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

         function addTimelineStep(title, description, status) {
             // If a step with the same title exists and we are updating it to 'in-progress' or 'complete', update it. Otherwise, add a new step.
             let existingStep = null;
             const steps = progressSteps.children;
             for (let i = 0; i < steps.length; i++) {
                 const titleElement = steps[i].querySelector('.step-title');
                 if (titleElement && titleElement.textContent === title) {
                      existingStep = steps[i];
                      break;
                 }
             }

             if (existingStep && (status === 'in-progress' || status === 'complete' || status === 'error')) {
                 updateExistingTimelineStep(existingStep, description, status);
             } else if (!existingStep || status === 'waiting') { // Add new step if not found or if it's just waiting
                  const step = document.createElement('div');
                  step.className = 'timeline-step'; // Base classes

                  const statusIndicator = getStatusIndicator(status);
                  const stepContent = `
                     <div class="timeline-line"></div>
                     <div class="timeline-indicator absolute left-0 top-0">
                         ${statusIndicator}
                     </div>
                     <div class="mb-1 text-sm font-medium step-title">${title}</div>
                     <p class="text-xs text-gray-500 dark:text-gray-400 step-description">${description}</p>
                 `;
                  step.innerHTML = stepContent;
                  progressSteps.appendChild(step);
             }
              progressSteps.scrollTop = progressSteps.scrollHeight;
         }

        function updateExistingTimelineStep(stepElement, description, status) {
             const indicatorContainer = stepElement.querySelector('.timeline-indicator');
             const descriptionElement = stepElement.querySelector('.step-description');

             if (indicatorContainer) {
                 indicatorContainer.innerHTML = getStatusIndicator(status);
             }
             if (descriptionElement) {
                 descriptionElement.textContent = description;
             }
        }

        function getStatusIndicator(status) {
             // Use Tailwind classes for styling indicators
             let baseClasses = "w-6 h-6 rounded-full flex items-center justify-center";
             let iconSvg = '';
             let bgColor = '';
             let iconColor = '';

             switch (status) {
                 case 'waiting':
                     bgColor = 'bg-gray-300 dark:bg-gray-600';
                     iconColor = 'text-gray-500 dark:text-gray-400';
                     iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z" clip-rule="evenodd" /></svg>`;
                     break;
                 case 'in-progress':
                     bgColor = 'bg-primary/20 dark:bg-primary/30';
                     iconColor = 'text-primary';
                     iconSvg = `<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                     break;
                 case 'complete':
                     bgColor = 'bg-green-100 dark:bg-green-900';
                     iconColor = 'text-green-600 dark:text-green-300';
                     iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                     break;
                 case 'error':
                     bgColor = 'bg-red-100 dark:bg-red-900';
                     iconColor = 'text-red-600 dark:text-red-300';
                     iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                     break;
                 default: // Unknown or initial state
                     bgColor = 'bg-gray-300 dark:bg-gray-600';
                     iconColor = 'text-gray-500 dark:text-gray-400';
                     iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
             }

             return `<div class="${baseClasses} ${bgColor} ${iconColor}">${iconSvg}</div>`;
         }

         function updateProgress(percent, statusText) {
             const clampedPercent = Math.max(0, Math.min(100, percent)); // Ensure percent is between 0 and 100
             progressBar.style.width = `${clampedPercent}%`;
             progressPercentage.textContent = `${clampedPercent}%`;
             currentStepLabel.textContent = statusText;
         }

        // --- Result Handling ---
         function generateResearchStats(stats) {
             const totalDuration = startTime ? Math.round((Date.now() - startTime) / 1000) : (stats.duration_seconds || 0);
             const minutes = Math.floor(totalDuration / 60);
             const seconds = totalDuration % 60;

             // Default values if stats are missing
             const steps = stats.steps_completed || 'N/A';
             const sources = stats.sources_consulted || 'N/A';
             const words = stats.word_count || 'N/A';
             const timeStr = `${minutes}m ${seconds}s`;

             researchStats.innerHTML = `
                 <div class="grid grid-cols-2 gap-4">
                     <div class="bg-gray-100 dark:bg-dark-input rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                         <div class="text-2xl font-bold text-primary">${steps}</div>
                         <div class="text-sm text-gray-600 dark:text-gray-400">Steps Executed</div>
                     </div>
                     <div class="bg-gray-100 dark:bg-dark-input rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                         <div class="text-2xl font-bold text-primary">${sources}</div>
                         <div class="text-sm text-gray-600 dark:text-gray-400">Sources Consulted</div>
                     </div>
                     <div class="bg-gray-100 dark:bg-dark-input rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                         <div class="text-2xl font-bold text-primary">${words}</div>
                         <div class="text-sm text-gray-600 dark:text-gray-400">Words Generated</div>
                     </div>
                     <div class="bg-gray-100 dark:bg-dark-input rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                         <div class="text-2xl font-bold text-primary">${timeStr}</div>
                         <div class="text-sm text-gray-600 dark:text-gray-400">Total Time</div>
                     </div>
                 </div>
             `;
         }

         function generateKeyInsights(insights) {
             if (!insights || insights.length === 0) {
                 keyInsights.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No key insights were extracted.</p>';
                 return;
             }

             keyInsights.innerHTML = insights.map(insight => `
                 <div class="bg-gray-100 dark:bg-dark-input rounded-lg p-3 flex items-start border border-gray-200 dark:border-gray-700">
                     <div class="text-primary mr-3 flex-shrink-0 mt-1">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                     </div>
                     <p class="text-sm">${insight}</p>
                 </div>
             `).join('');
         }


        function copyResults() {
            const markdownContent = researchContent.getAttribute('data-markdown');
            if (markdownContent) {
                navigator.clipboard.writeText(markdownContent)
                    .then(() => showNotification('Markdown copied to clipboard.', 'success'))
                    .catch(err => showNotification(`Failed to copy: ${err}`, 'error'));
            } else {
                showNotification('No content to copy.', 'info');
            }
        }

        function downloadResults() {
             const markdownContent = researchContent.getAttribute('data-markdown');
             const topic = researchTopicInput.value.trim().replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'research_report';
             const filename = `${topic}.md`;

             if (markdownContent) {
                 const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(blob);
                 link.download = filename;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 URL.revokeObjectURL(link.href);
                 showNotification('Markdown file download initiated.', 'success');
             } else {
                 showNotification('No content to download.', 'info');
             }
        }

        // --- Utility Functions ---
        function showNotification(message, type = 'info') {
             const notificationId = `notif-${Date.now()}`;
             const notificationDiv = document.createElement('div');
             notificationDiv.id = notificationId;
             notificationDiv.className = `flex items-center p-4 mb-2 rounded-lg shadow-lg text-sm transition-all duration-300 ease-out transform translate-x-full opacity-0 animate-slide-in ${
                 type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 border border-red-300 dark:border-red-700' :
                 type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200 border border-green-300 dark:border-green-700' :
                 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 border border-blue-300 dark:border-blue-700' // Default to info
             }`;

             const iconSvg = type === 'error' ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4a1 1 0 102 0V5zm-1 7a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>`
                           : type === 'success' ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l5-5z" clip-rule="evenodd" /></svg>`
                           : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>`; // Info icon

             notificationDiv.innerHTML = `
                ${iconSvg}
                <span class="flex-1">${message}</span>
                <button onclick="dismissNotification('${notificationId}')" class="ml-4 -mr-1 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
             `;
             notificationArea.appendChild(notificationDiv);

             // Trigger animation
             requestAnimationFrame(() => {
                 notificationDiv.classList.remove('translate-x-full', 'opacity-0');
                 notificationDiv.classList.add('translate-x-0', 'opacity-100');
             });

             // Auto-dismiss after 5 seconds
             setTimeout(() => {
                 dismissNotification(notificationId);
             }, 5000);
         }

        window.dismissNotification = (id) => { // Make it globally accessible
            const notification = document.getElementById(id);
            if (notification) {
                notification.classList.remove('translate-x-0', 'opacity-100');
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    notification.remove();
                }, 300); // Remove from DOM after transition
            }
        }

        // Add keyframe animation styles dynamically
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes slide-in {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
            .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>
